<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Astro Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
    }

    @keyframes fade-in-slide-up {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .message-bubble { animation: fade-in-slide-up 0.3s ease-out; }

    .animated-gradient-bg {
      background: linear-gradient(
        120deg,
        #1e1b4b, /* indigo-950 */
        #4338ca, /* violet-700 */
        #be185d, /* fuchsia-700 */
        #0f172a  /* slate-900 */
      );
      background-size: 300% 300%;
      animation: gradient-flow 20s ease-in-out infinite;
    }

    @keyframes gradient-flow {
      0%   { background-position: 0% 50%; }
      50%  { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .custom-scrollbar::-webkit-scrollbar { width: 8px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
    .custom-scrollbar::-webkit-scrollbar-thumb {
      background-color: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      border: 2px solid transparent;
      background-clip: content-box;
    }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background-color: rgba(255, 255, 255, 0.4); }
  </style>
</head>
<body class="animated-gradient-bg sm:flex sm:items-center sm:justify-center sm:min-h-screen sm:p-4">
  <div class="relative w-full md:w-2/3 h-screen mx-auto sm:rounded-2xl sm:shadow-2xl flex flex-col overflow-hidden">
    
    <!-- Header -->
    <div class="p-4 border-b border-white/10 flex items-center justify-between bg-slate-900/70 backdrop-blur-sm sm:rounded-t-2xl sticky top-0 z-10">
      <h1 class="text-xl font-bold text-slate-100 tracking-tight">ðŸ”® Astro Chat</h1>
      <div class="flex items-center space-x-2">
        <button id="conversational-mode-btn" type="button" class="flex items-center space-x-2 px-4 py-2 text-sm font-medium text-slate-300 bg-white/10 hover:bg-white/20 rounded-full transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-400" title="Toggle Conversational Mode">
          <svg xmlns="http://www.w.org/2000/svg" class="h-5 w-5 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
          <span>Talk Mode</span>
        </button>
        <button id="voice-toggle-btn" type="button" class="p-2 text-slate-400 hover:bg-white/10 hover:text-violet-400 rounded-full transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-400" title="Toggle Voice Output">
            <svg id="voice-on-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" /></svg>
            <svg id="voice-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" clip-rule="evenodd" /><path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" /></svg>
        </button>
        <a href="{% url 'logout' %}" class="p-2 text-slate-400 hover:bg-white/10 hover:text-violet-400 rounded-full transition-colors focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-400" title="Logout">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
        </a>
      </div>
    </div>

    <div id="chat-history" class="animated-gradient-bg flex-1 p-6 space-y-4 overflow-y-auto custom-scrollbar" aria-live="polite"></div>

    <div id="action-area" class="p-4 border-t border-white/10 bg-slate-900/50 backdrop-blur-sm sm:rounded-b-2xl">
      <div id="typing-indicator" class="h-10 flex items-center mb-1 hidden">
         <div class="inline-flex items-center space-x-2 bg-slate-800/80 rounded-full px-4 py-2">
            <div class="w-2.5 h-2.5 bg-violet-400 rounded-full animate-pulse"></div>
            <div class="w-2.5 h-2.5 bg-violet-400 rounded-full animate-pulse [animation-delay:0.2s]"></div>
            <div class="w-2.5 h-2.5 bg-violet-400 rounded-full animate-pulse [animation-delay:0.4s]"></div>
            <span class="text-sm font-medium text-slate-400">Bot is typing...</span>
          </div>
      </div>
      <form id="chat-form" method="post" autocomplete="off" class="relative flex items-center">
        {% csrf_token %}
        <button id="mic-btn" type="button" class="absolute left-2 p-2 text-gray-400 hover:text-purple-600 transition-colors rounded-full focus:outline-none focus-visible:ring-2 focus-visible:ring-purple-400" title="Use Voice Input">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>
        </button>
        <input id="user-input" name="message" type="text" placeholder="Type or press the mic..." class="w-full py-3 pl-12 pr-16 text-gray-800 bg-white border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-400 placeholder:text-gray-500 disabled:bg-gray-200" />
        <button id="send-btn" type="submit" class="absolute right-2 p-2 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition-colors disabled:bg-purple-300 focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2 focus-visible:ring-purple-500" title="Send">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>
        </button>
      </form>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- DOM Elements & State ---
        const chatHistory = document.getElementById('chat-history');
        const form = document.getElementById('chat-form');
        const input = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const voiceToggleBtn = document.getElementById('voice-toggle-btn');
        const voiceOnIcon = document.getElementById('voice-on-icon');
        const voiceOffIcon = document.getElementById('voice-off-icon');
        const convoModeBtn = document.getElementById('conversational-mode-btn');
        const typingIndicator = document.getElementById('typing-indicator');

        let isVoiceEnabled = true;
        let isConversationalMode = false;
        const csrftoken = getCookie('csrftoken');

        // --- Helper Functions ---
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        const scrollToBottom = () => chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: 'smooth' });
        const showTyping = (show) => {
            typingIndicator.classList.toggle('hidden', !show);
            if (show) scrollToBottom();
        };

        function addMessage(text, sender) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            const bubble = document.createElement('div');
            bubble.className = `p-3 rounded-2xl max-w-[85%] shadow-sm message-bubble whitespace-pre-wrap ${sender === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-purple-100 text-gray-800 rounded-bl-none'}`;
            bubble.textContent = text;
            messageDiv.appendChild(bubble);
            chatHistory.appendChild(messageDiv);
            scrollToBottom();
            if (sender === 'bot') speak(text);
        }

        // --- Speech Synthesis (Text-to-Speech) ---
        function speak(text) {
            if (!isVoiceEnabled || !('speechSynthesis' in window)) return;
            speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(utterance);
        }

        voiceToggleBtn.addEventListener('click', () => {
            isVoiceEnabled = !isVoiceEnabled;
            voiceOnIcon.classList.toggle('hidden');
            voiceOffIcon.classList.toggle('hidden');
            if (!isVoiceEnabled) {
                speechSynthesis.cancel();
            }
        });

        // --- Speech Recognition (Speech-to-Text) & Conversational Mode ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (SpeechRecognition) {
            const recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.lang = 'en-US';
            recognition.interimResults = false;

            micBtn.addEventListener('click', () => {
                if (isConversationalMode) return;
                try { recognition.start(); } catch(e) {}
            });
            
            convoModeBtn.addEventListener('click', () => {
                isConversationalMode = !isConversationalMode;
                convoModeBtn.classList.toggle('bg-white/20', isConversationalMode);
                convoModeBtn.querySelector('span').textContent = isConversationalMode ? 'Manual Mode' : 'Talk Mode';
                
                if (isConversationalMode) {
                    try { recognition.start(); } catch(e) {}
                } else {
                    recognition.stop();
                }
            });

            recognition.onstart = () => { micBtn.firstElementChild.classList.add('text-purple-600', 'animate-pulse'); };
            recognition.onend = () => {
                micBtn.firstElementChild.classList.remove('text-purple-600', 'animate-pulse');
                if (isConversationalMode) { 
                    try { recognition.start(); } catch(e) {}
                }
            };

            recognition.onresult = (event) => {
                const transcript = event.results[event.results.length - 1][0].transcript.trim();
                if (transcript) {
                    input.value = transcript;
                    form.requestSubmit();
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
                if (event.error === 'no-speech' && isConversationalMode) return;
                addMessage(`Sorry, I couldn't understand. Error: ${event.error}`, 'bot');
            };
        } else {
            micBtn.style.display = 'none';
            voiceToggleBtn.style.display = 'none';
            convoModeBtn.style.display = 'none';
        }

        // --- Main Chat Logic ---
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = input.value.trim();
            if (!text) return;

            addMessage(text, 'user');
            input.value = '';
            showTyping(true);
            
            sendBtn.disabled = true;
            micBtn.disabled = true;
            convoModeBtn.disabled = true;
            input.disabled = true;

            try {
                const formData = new FormData();
                formData.append('message', text);
                const endpoint = "{% url 'chat_api' %}";

                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'X-CSRFToken': csrftoken },
                    body: formData
                });
                
                if (!res.ok) throw new Error(`Server error: ${res.status}`);

                const data = await res.json();
                const replyText = data.reply || 'Sorry, I could not process that.';
                showTyping(false);
                addMessage(replyText, 'bot');

            } catch (err) {
                console.error("Fetch error:", err);
                showTyping(false);
                addMessage('Error: Could not connect to the server. Please try again.', 'bot');
            } finally {
                sendBtn.disabled = false;
                micBtn.disabled = false;
                convoModeBtn.disabled = false;
                input.disabled = false;
                input.focus();
            }
        });

        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                form.requestSubmit();
            }
        });

        // Initial welcome message
        setTimeout(() => {
          addMessage("Hello! I am your Astro Chat assistant. How can I help you with your astrological queries today?", "bot");
        }, 500);
    });
  </script>
</body>
</html>