{% load static %}
{% if not user.is_authenticated %}
<script>
  alert('Login to continue');
  window.location.href = "/";
</script>
{% endif %}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Personality Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(135deg, #8cd198, #fbc2eb);
    }

    #grad {
      background: linear-gradient(135deg, #fbc2eb, #8cd198);
    }

    #chat-history::-webkit-scrollbar {
      width: 6px;
    }

    #chat-history::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    #chat-history::-webkit-scrollbar-thumb {
      background: #a8a29e;
      border-radius: 6px;
    }

    #chat-history::-webkit-scrollbar-thumb:hover {
      background: #78716c;
    }

    @keyframes fade-in-slide-up {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-bubble {
      animation: fade-in-slide-up 0.3s ease-out;
    }
  </style>
  {{ questions|json_script:"questions-data" }}
  {{ options|json_script:"options-data" }}
</head>

<body class="bg-gray-100">
  <div class="relative w-full md:w-2/3 h-screen mx-auto bg-white sm:rounded-2xl sm:shadow-2xl flex flex-col" id="grad">

    <!-- Header -->
    <div class="p-2 border-b flex items-center justify-end bg-white sm:rounded-t-2xl sticky top-0 z-10 space-x-2">
      <button id="continuous-mic-btn" type="button"
        class="flex items-center space-x-2 px-3 py-1 text-sm text-gray-600 hover:bg-gray-200 rounded-full transition-colors"
        title="Toggle Continuous Mic Mode">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"
          stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
        </svg>
        <span id="continuous-mic-text">Conversational Chat</span>
      </button>
      <button id="voice-toggle-btn" type="button"
        class="p-1 text-gray-500 hover:bg-gray-100 hover:text-purple-600 rounded-full transition-colors"
        title="Toggle Voice Output">
        <svg id="voice-on-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
        </svg>
        <svg id="voice-off-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none"
          viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"
            clip-rule="evenodd" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M17 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2" />
        </svg>
      </button>
      <form method="post" action="{% url 'logout' %}">
        {% csrf_token %}
        <button type="submit"
          class="p-2 text-gray-500 hover:bg-gray-100 hover:text-purple-600 rounded-full transition-colors"
          title="Logout">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
            stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
        </button>
      </form>
    </div>

    <div id="chat-history" class="flex-1 p-4 space-y-4 overflow-y-auto">
      {% if profile %}
      <div class="p-4 sm:p-5 bg-purple-50 rounded-lg shadow-inner message-bubble">
        <h2 class="text-lg sm:text-xl font-bold text-purple-800 mb-3 border-b-2 border-purple-200 pb-2">Your Personality
          Profile</h2>
        <div id="profile-content-text" class="text-sm sm:text-base whitespace-pre-wrap text-gray-700">{{ profile|safe }}
        </div>
      </div>
      {% endif %}
    </div>

    <div id="action-area" class="p-3 sm:p-4 border-t bg-gray-50 sm:rounded-b-2xl">
      {% if profile %}
      <div class="text-center space-y-3">
        <a href="/home/"
          class="inline-block py-3 px-8 bg-purple-600 text-white rounded-full font-semibold hover:bg-purple-700 transition transform hover:-translate-y-0.5 shadow-md">Start
          Over</a>
        <a href="/astro/"
          class="inline-block py-3 px-8 bg-purple-600 text-white rounded-full font-semibold hover:bg-purple-700 transition transform hover:-translate-y-0.5 shadow-md">Astro
          Analysis</a>
      </div>
      {% else %}
      <div id="quick-reply-container"></div>
      <div id="typing-indicator" class="hidden">
        <div class="flex items-center space-x-2 p-2">
          <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
          <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse [animation-delay:0.2s]"></div>
          <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse [animation-delay:0.4s]"></div>
          <span class="text-sm text-gray-500">Bot is typing...</span>
        </div>
      </div>
      {% endif %}
    </div>
  </div>

  <script>
    // --- 1. Universal Setup ---
    const voiceToggleBtn = document.getElementById('voice-toggle-btn');
    if (voiceToggleBtn) {
      const voiceOnIcon = document.getElementById('voice-on-icon');
      const voiceOffIcon = document.getElementById('voice-off-icon');
      let isVoiceEnabled = true;
      voiceToggleBtn.addEventListener('click', () => {
        isVoiceEnabled = !isVoiceEnabled;
        voiceOnIcon.classList.toggle('hidden');
        voiceOffIcon.classList.toggle('hidden');
        if (!isVoiceEnabled && window.speechSynthesis) window.speechSynthesis.cancel();
        voiceToggleBtn.title = isVoiceEnabled ? 'Mute Voice Output' : 'Unmute Voice Output';
      });

      window.speak = function (text) {
        if (!isVoiceEnabled || !window.speechSynthesis) return;
        window.speechSynthesis.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(utterance);
      };
    } else {
      window.speak = function () { };
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isContinuousMicOn = false;
    let isListening = false;
    let currentMicButton = null;

    if (SpeechRecognition) {
      recognition = new SpeechRecognition();
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;
      recognition.lang = 'en-US';

      const continuousMicBtn = document.getElementById('continuous-mic-btn');
      continuousMicBtn.addEventListener('click', () => {
        isContinuousMicOn = !isContinuousMicOn;
        recognition.continuous = false; // Always false to enable auto-submit on pause
        continuousMicBtn.classList.toggle('bg-purple-200', isContinuousMicOn);
        continuousMicBtn.classList.toggle('text-purple-800', isContinuousMicOn);

        if (isContinuousMicOn && !isListening) {
          try { recognition.start(); } catch (e) { }
        } else if (!isContinuousMicOn && isListening) {
          recognition.stop();
        }
      });
    }

    // --- 2. Main Chat Logic ---
    document.addEventListener('DOMContentLoaded', function () {
      const profileContent = document.getElementById('profile-content-text');
      if (profileContent) {
        speak("Here is your personality profile. " + profileContent.textContent);
        return;
      }

      const chatHistory = document.getElementById('chat-history');
      const quickReplyContainer = document.getElementById('quick-reply-container');
      const typingIndicator = document.getElementById('typing-indicator');

      if (!chatHistory || !quickReplyContainer || !typingIndicator) return;

      const scrollToBottom = () => chatHistory.scrollTo({ top: chatHistory.scrollHeight, behavior: 'smooth' });
      const showTyping = (show) => {
        typingIndicator.classList.toggle('hidden', !show);
        if (show) scrollToBottom();
      };

      function addMessage(text, sender) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `flex mb-2 ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
        const bubble = document.createElement('div');
        bubble.className = `p-3 rounded-2xl max-w-[85%] shadow-sm message-bubble ${sender === 'user' ? 'bg-purple-600 text-white rounded-br-none' : 'bg-purple-100 text-gray-800 rounded-bl-none'}`;
        bubble.textContent = text;
        messageDiv.appendChild(bubble);
        chatHistory.appendChild(messageDiv);
        scrollToBottom();
        if (sender === 'bot') speak(text);
      }

      function setupSpeechRecognition(micBtn, inputEl) {
        if (!recognition) {
          if (micBtn) micBtn.style.display = 'none';
          return;
        };

        currentMicButton = micBtn; // Keep track of the current mic button to animate

        micBtn.addEventListener('click', () => {
          if (isListening) {
            recognition.stop();
          } else {
            try { recognition.start(); } catch (e) { console.error("Mic start error:", e); }
          }
        });

        recognition.onstart = () => {
          isListening = true;
          if (currentMicButton) currentMicButton.firstElementChild.classList.add('text-purple-600', 'animate-pulse');
        };

        recognition.onresult = (event) => {
          const transcript = event.results[event.resultIndex][0].transcript;
          inputEl.value = transcript;
        };

        recognition.onend = () => {
          if (currentMicButton) currentMicButton.firstElementChild.classList.remove('text-purple-600', 'animate-pulse');

          // ✅ Check if speech was captured and submit automatically
          const finalTranscript = inputEl.value.trim();
          if (isListening && finalTranscript) {
            inputEl.form.requestSubmit();
            inputEl.value = ''; // Clear for next round
          }

          isListening = false;

          // ✅ If in continuous mode, restart listening automatically
          if (isContinuousMicOn) {
            try { recognition.start(); } catch (e) { /* Fails silently if already started */ }
          }
        };

        recognition.onerror = (event) => {
          if (event.error !== 'no-speech' && event.error !== 'aborted') {
            console.error('Speech recognition error:', event.error);
          }
          isListening = false;
          if (currentMicButton) currentMicButton.firstElementChild.classList.remove('text-purple-600', 'animate-pulse');
        };
      }

      try {
        let questions = JSON.parse(document.getElementById('questions-data').textContent);
        let options = JSON.parse(document.getElementById('options-data').textContent);
        let currentIndex = 0;

        const form = document.createElement('form');
        form.method = 'post';
        form.action = "{% url 'submit' %}";
        form.id = 'chat-form';
        form.innerHTML = `{% csrf_token %}<input type="hidden" name="intro" value="">`;
        document.body.appendChild(form);

        function showQuickReplies() {
          quickReplyContainer.innerHTML = '';
          quickReplyContainer.classList.remove('hidden');

          const formEl = document.createElement('form');
          formEl.className = 'relative';
          formEl.onsubmit = (e) => {
            e.preventDefault();
            const inputVal = formEl.elements['text-answer'].value.trim();
            if (inputVal) handleReply(inputVal);
          };

          const inputGroup = document.createElement('div');
          inputGroup.className = 'relative flex items-center';

          const micBtn = document.createElement('button');
          micBtn.type = 'button';
          micBtn.className = 'p-2 text-gray-400 hover:text-purple-600 transition';
          micBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" /></svg>`;
          inputGroup.appendChild(micBtn);

          let inputEl;
          if (currentIndex === 0) {
            inputEl = document.createElement('textarea');
            inputEl.id = 'chat-textarea';
            inputEl.rows = 2;
            inputEl.placeholder = 'Type or speak your introduction...';
            inputEl.className = 'w-full p-3 pl-2 pr-16 text-gray-700 bg-white border border-gray-300 rounded-2xl focus:outline-none focus:ring-2 focus:ring-purple-400 resize-none';
          } else {
            inputEl = document.createElement('input');
            inputEl.type = 'text';
            inputEl.placeholder = 'Type, speak, or click an option...';
            inputEl.className = 'w-full py-3 pl-2 pr-16 text-gray-700 bg-white border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-purple-400';
          }
          inputEl.name = 'text-answer';
          inputEl.required = true;
          inputEl.autocomplete = 'off';
          inputGroup.appendChild(inputEl);

          setupSpeechRecognition(micBtn, inputEl);

          const submitBtn = document.createElement('button');
          submitBtn.type = 'submit';
          submitBtn.id = 'submitBtn';
          submitBtn.className = 'absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-purple-600 text-white rounded-full hover:bg-purple-700 transition';
          submitBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.428A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z" /></svg>`;
          inputGroup.appendChild(submitBtn);

          formEl.appendChild(inputGroup);

          if (currentIndex > 0 && options[currentIndex] && options[currentIndex].length > 0) {
            const optsDiv = document.createElement('div');
            optsDiv.className = 'flex flex-wrap gap-2 justify-center pt-3';
            options[currentIndex].forEach(opt => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'px-4 py-2 bg-gray-200 hover:bg-purple-200 text-gray-800 rounded-full transition-colors text-sm';
              btn.textContent = opt;
              btn.onclick = () => { inputEl.value = opt; formEl.requestSubmit(); };
              optsDiv.appendChild(btn);
            });
            formEl.prepend(optsDiv);
          }
          quickReplyContainer.appendChild(formEl);
          inputEl.focus();
        }

        // --- MODIFIED FUNCTION ---
        function handleReply(answer) {
          // Manually stop recognition if it's running to prevent feedback loop
          if (isListening) {
            isContinuousMicOn = false; // Temporarily disable to prevent immediate restart
            recognition.stop();
            isContinuousMicOn = document.getElementById('continuous-mic-btn').classList.contains('bg-purple-200'); // Restore state
          }

          addMessage(answer, 'user');
          quickReplyContainer.classList.add('hidden');
          showTyping(true); // <-- MODIFIED: Show typing indicator immediately after user reply

          const questionText = questions[currentIndex].replace(/[\[\]"]/g, '');
          if (currentIndex === 0) form.querySelector('input[name="intro"]').value = answer;

          const qInput = document.createElement('input');
          qInput.type = 'hidden'; qInput.name = `question_${currentIndex}`; qInput.value = questionText; form.appendChild(qInput);
          const aInput = document.createElement('input');
          aInput.type = 'hidden'; aInput.name = `answer_${currentIndex}`; aInput.value = answer; form.appendChild(aInput);

          const formData = new FormData();
          formData.append('question', questionText);
          formData.append('answer', answer);
          formData.append('currentIndex', currentIndex);
          formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

          fetch("{% url 'feedback' %}", { method: 'POST', body: formData })
            .then(res => res.json()).then(data => {
              showTyping(false); // <-- MODIFIED: Hide indicator before showing bot message
              addMessage(data.feedback, 'bot');
              if (data.next_questions) {
                questions.push(...data.next_questions.map(item => item.question));
                options.push(...data.next_questions.map(item => item.options));
              }
              proceedToNextStep();
            }).catch((error) => {
              showTyping(false); // <-- MODIFIED: Also hide on error
              console.error("Feedback API error:", error);
              addMessage("Thanks! Let's move on.", 'bot');
              proceedToNextStep();
            });
        }

        const proceedToNextStep = () => {
          currentIndex++;
          if (currentIndex < questions.length) {
            setTimeout(askNextQuestion, 800);
          } else {
            setTimeout(submitProfile, 1000);
          }
        };

        function askNextQuestion() {
          showTyping(true);
          setTimeout(() => {
            showTyping(false);
            const q = questions[currentIndex].replace(/[\[\]"]/g, '');
            addMessage(q, 'bot');
            showQuickReplies();

            if (isContinuousMicOn && !isListening) {
              try { recognition.start(); } catch (e) { }
            }
          }, 1200);
        }

        function submitProfile() {
          const loadingOverlay = document.getElementById('loading-overlay');
          showTyping(true);
          setTimeout(() => {
            showTyping(false);
            addMessage("Great, I have everything I need. I'm now creating your personality profile.", 'bot');
            
            if (loadingOverlay) {
                loadingOverlay.classList.remove('hidden');
            }

            setTimeout(() => {
                form.submit();
            }, 500); 
            
          }, 1000);
        }

        // --- CONVERSATION START ---
        askNextQuestion();

      } catch (error) {
        console.error("Chatbot Initialization Error:", error);
        addMessage(`Oops! Something went wrong. I couldn't start the chat. Please try refreshing the page.`, 'bot');
        if (quickReplyContainer) quickReplyContainer.style.display = 'none';
      }
    });
  </script>

  <!-- Loading Spinner Overlay -->
  <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-80 backdrop-blur-sm flex flex-col items-center justify-center hidden z-50">
    <div class="w-16 h-16 border-4 border-purple-300 border-t-purple-600 rounded-full animate-spin"></div>
    <p class="text-purple-800 mt-4 text-lg font-semibold">Analyzing your profile...</p>
    <p class="text-gray-600 mt-1">Please wait a moment.</p>
  </div>
</body>

</html>